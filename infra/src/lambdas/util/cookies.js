"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateCookies = exports.extractAndParseCookies = void 0;
const cookie_1 = require("cookie");
const jwt_1 = require("./jwt");
/**
 * Cookies are present in the HTTP header "Cookie" that may be present
 * multiple times. This utility function parses occurrences  of that
 * header and splits out all the cookies and their values.
 * A simple object is returned that allows easy access by cookie
 * name: e.g. cookies["nonce"].
 */
function extractCookiesFromHeaders(headers) {
    if (!headers["cookie"]) {
        return {};
    }
    const cookies = headers["cookie"].reduce((reduced, header) => ({
        ...reduced,
        ...(0, cookie_1.parse)(header.value),
    }), {});
    return cookies;
}
function withCookieDomain(distributionDomainName, cookieSettings) {
    if (cookieSettings.toLowerCase().indexOf("domain") === -1) {
        // Add leading dot for compatibility with Amplify (or js-cookie really).
        return `${cookieSettings}; Domain=.${distributionDomainName}`;
    }
    return cookieSettings;
}
function extractAndParseCookies(headers, clientId) {
    const cookies = extractCookiesFromHeaders(headers);
    if (!cookies) {
        return {};
    }
    const keyPrefix = `CognitoIdentityServiceProvider.${clientId}`;
    const tokenUserName = cookies[`${keyPrefix}.LastAuthUser`];
    return {
        tokenUserName,
        idToken: cookies[`${keyPrefix}.${tokenUserName ?? ""}.idToken`],
        accessToken: cookies[`${keyPrefix}.${tokenUserName ?? ""}.accessToken`],
        refreshToken: cookies[`${keyPrefix}.${tokenUserName ?? ""}.refreshToken`],
        scopes: cookies[`${keyPrefix}.${tokenUserName ?? ""}.tokenScopesString`],
        nonce: cookies["spa-auth-edge-nonce"],
        nonceHmac: cookies["spa-auth-edge-nonce-hmac"],
        pkce: cookies["spa-auth-edge-pkce"],
    };
}
exports.extractAndParseCookies = extractAndParseCookies;
function generateCookies(param) {
    // Set cookies with the exact names and values Amplify uses
    // for seamless interoperability with Amplify.
    const decodedIdToken = (0, jwt_1.decodeIdToken)(param.tokens.idToken);
    const tokenUserName = decodedIdToken["cognito:username"];
    const keyPrefix = `CognitoIdentityServiceProvider.${param.clientId}`;
    const idTokenKey = `${keyPrefix}.${tokenUserName}.idToken`;
    const accessTokenKey = `${keyPrefix}.${tokenUserName}.accessToken`;
    const refreshTokenKey = `${keyPrefix}.${tokenUserName}.refreshToken`;
    const lastUserKey = `${keyPrefix}.LastAuthUser`;
    const scopeKey = `${keyPrefix}.${tokenUserName}.tokenScopesString`;
    const scopesString = param.oauthScopes.join(" ");
    const userDataKey = `${keyPrefix}.${tokenUserName}.userData`;
    const userData = JSON.stringify({
        UserAttributes: [
            {
                Name: "sub",
                Value: decodedIdToken["sub"],
            },
            {
                Name: "email",
                Value: decodedIdToken["email"],
            },
        ],
        Username: tokenUserName,
    });
    // Construct object with the cookies
    const cookies = {
        [idTokenKey]: `${param.tokens.idToken}; ${withCookieDomain(param.domainName, param.cookieSettings.idToken)}`,
        [accessTokenKey]: `${param.tokens.accessToken}; ${withCookieDomain(param.domainName, param.cookieSettings.accessToken)}`,
        [refreshTokenKey]: `${param.tokens.refreshToken}; ${withCookieDomain(param.domainName, param.cookieSettings.refreshToken)}`,
        [lastUserKey]: `${tokenUserName}; ${withCookieDomain(param.domainName, param.cookieSettings.idToken)}`,
        [scopeKey]: `${scopesString}; ${withCookieDomain(param.domainName, param.cookieSettings.accessToken)}`,
        [userDataKey]: `${encodeURIComponent(userData)}; ${withCookieDomain(param.domainName, param.cookieSettings.idToken)}`,
        "amplify-signin-with-hostedUI": `true; ${withCookieDomain(param.domainName, param.cookieSettings.accessToken)}`,
    };
    if (param.event === "signOut") {
        // Expire all cookies
        Object.keys(cookies).forEach((key) => (cookies[key] = expireCookie(cookies[key])));
    }
    else if (param.event === "refreshFailed") {
        // Expire refresh token (so the browser will not send it in vain again)
        cookies[refreshTokenKey] = expireCookie(cookies[refreshTokenKey]);
    }
    // Nonce, nonceHmac and pkce are only used during login phase.
    ;
    [
        "spa-auth-edge-nonce",
        "spa-auth-edge-nonce-hmac",
        "spa-auth-edge-pkce",
    ].forEach((key) => {
        cookies[key] = expireCookie(cookies[key]);
    });
    return Object.entries(cookies).map(([k, v]) => `${k}=${v}`);
}
exports.generateCookies = generateCookies;
function expireCookie(cookie = "") {
    const cookieParts = cookie
        .split(";")
        .map((part) => part.trim())
        .filter((part) => !part.toLowerCase().startsWith("max-age"))
        .filter((part) => !part.toLowerCase().startsWith("expires"));
    const expires = `Expires=${new Date(0).toUTCString()}`;
    // First part is the cookie value, which we'll clear.
    return ["", ...cookieParts.slice(1), expires].join("; ");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29va2llcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvb2tpZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsbUNBQThCO0FBQzlCLCtCQUFxQztBQVdyQzs7Ozs7O0dBTUc7QUFDSCxTQUFTLHlCQUF5QixDQUFDLE9BQTBCO0lBQzNELElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7UUFDdEIsT0FBTyxFQUFFLENBQUE7S0FDVjtJQUNELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQ3RDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNwQixHQUFHLE9BQU87UUFDVixHQUFJLElBQUEsY0FBSyxFQUFDLE1BQU0sQ0FBQyxLQUFLLENBQWE7S0FDcEMsQ0FBQyxFQUNGLEVBQUUsQ0FDSCxDQUFBO0lBRUQsT0FBTyxPQUFPLENBQUE7QUFDaEIsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQ3ZCLHNCQUE4QixFQUM5QixjQUFzQjtJQUV0QixJQUFJLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7UUFDekQsd0VBQXdFO1FBQ3hFLE9BQU8sR0FBRyxjQUFjLGFBQWEsc0JBQXNCLEVBQUUsQ0FBQTtLQUM5RDtJQUNELE9BQU8sY0FBYyxDQUFBO0FBQ3ZCLENBQUM7QUFFRCxTQUFnQixzQkFBc0IsQ0FDcEMsT0FBMEIsRUFDMUIsUUFBZ0I7SUFXaEIsTUFBTSxPQUFPLEdBQUcseUJBQXlCLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDbEQsSUFBSSxDQUFDLE9BQU8sRUFBRTtRQUNaLE9BQU8sRUFBRSxDQUFBO0tBQ1Y7SUFFRCxNQUFNLFNBQVMsR0FBRyxrQ0FBa0MsUUFBUSxFQUFFLENBQUE7SUFDOUQsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsU0FBUyxlQUFlLENBQUMsQ0FBQTtJQUUxRCxPQUFPO1FBQ0wsYUFBYTtRQUNiLE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxTQUFTLElBQUksYUFBYSxJQUFJLEVBQUUsVUFBVSxDQUFDO1FBQy9ELFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxTQUFTLElBQUksYUFBYSxJQUFJLEVBQUUsY0FBYyxDQUFDO1FBQ3ZFLFlBQVksRUFBRSxPQUFPLENBQUMsR0FBRyxTQUFTLElBQUksYUFBYSxJQUFJLEVBQUUsZUFBZSxDQUFDO1FBQ3pFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxTQUFTLElBQUksYUFBYSxJQUFJLEVBQUUsb0JBQW9CLENBQUM7UUFDeEUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQztRQUNyQyxTQUFTLEVBQUUsT0FBTyxDQUFDLDBCQUEwQixDQUFDO1FBQzlDLElBQUksRUFBRSxPQUFPLENBQUMsb0JBQW9CLENBQUM7S0FDcEMsQ0FBQTtBQUNILENBQUM7QUEvQkQsd0RBK0JDO0FBRUQsU0FBZ0IsZUFBZSxDQUFDLEtBVy9CO0lBQ0MsMkRBQTJEO0lBQzNELDhDQUE4QztJQUM5QyxNQUFNLGNBQWMsR0FBRyxJQUFBLG1CQUFhLEVBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUMxRCxNQUFNLGFBQWEsR0FBRyxjQUFjLENBQUMsa0JBQWtCLENBQVcsQ0FBQTtJQUNsRSxNQUFNLFNBQVMsR0FBRyxrQ0FBa0MsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFBO0lBQ3BFLE1BQU0sVUFBVSxHQUFHLEdBQUcsU0FBUyxJQUFJLGFBQWEsVUFBVSxDQUFBO0lBQzFELE1BQU0sY0FBYyxHQUFHLEdBQUcsU0FBUyxJQUFJLGFBQWEsY0FBYyxDQUFBO0lBQ2xFLE1BQU0sZUFBZSxHQUFHLEdBQUcsU0FBUyxJQUFJLGFBQWEsZUFBZSxDQUFBO0lBQ3BFLE1BQU0sV0FBVyxHQUFHLEdBQUcsU0FBUyxlQUFlLENBQUE7SUFDL0MsTUFBTSxRQUFRLEdBQUcsR0FBRyxTQUFTLElBQUksYUFBYSxvQkFBb0IsQ0FBQTtJQUNsRSxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUNoRCxNQUFNLFdBQVcsR0FBRyxHQUFHLFNBQVMsSUFBSSxhQUFhLFdBQVcsQ0FBQTtJQUM1RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzlCLGNBQWMsRUFBRTtZQUNkO2dCQUNFLElBQUksRUFBRSxLQUFLO2dCQUNYLEtBQUssRUFBRSxjQUFjLENBQUMsS0FBSyxDQUFDO2FBQzdCO1lBQ0Q7Z0JBQ0UsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsS0FBSyxFQUFFLGNBQWMsQ0FBQyxPQUFPLENBQUM7YUFDL0I7U0FDRjtRQUNELFFBQVEsRUFBRSxhQUFhO0tBQ3hCLENBQUMsQ0FBQTtJQUVGLG9DQUFvQztJQUNwQyxNQUFNLE9BQU8sR0FBRztRQUNkLENBQUMsVUFBVSxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sS0FBSyxnQkFBZ0IsQ0FDeEQsS0FBSyxDQUFDLFVBQVUsRUFDaEIsS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQzdCLEVBQUU7UUFDSCxDQUFDLGNBQWMsQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEtBQUssZ0JBQWdCLENBQ2hFLEtBQUssQ0FBQyxVQUFVLEVBQ2hCLEtBQUssQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUNqQyxFQUFFO1FBQ0gsQ0FBQyxlQUFlLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsWUFBWSxLQUFLLGdCQUFnQixDQUNsRSxLQUFLLENBQUMsVUFBVSxFQUNoQixLQUFLLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FDbEMsRUFBRTtRQUNILENBQUMsV0FBVyxDQUFDLEVBQUUsR0FBRyxhQUFhLEtBQUssZ0JBQWdCLENBQ2xELEtBQUssQ0FBQyxVQUFVLEVBQ2hCLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUM3QixFQUFFO1FBQ0gsQ0FBQyxRQUFRLENBQUMsRUFBRSxHQUFHLFlBQVksS0FBSyxnQkFBZ0IsQ0FDOUMsS0FBSyxDQUFDLFVBQVUsRUFDaEIsS0FBSyxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQ2pDLEVBQUU7UUFDSCxDQUFDLFdBQVcsQ0FBQyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxDQUFDLEtBQUssZ0JBQWdCLENBQ2pFLEtBQUssQ0FBQyxVQUFVLEVBQ2hCLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUM3QixFQUFFO1FBQ0gsOEJBQThCLEVBQUUsU0FBUyxnQkFBZ0IsQ0FDdkQsS0FBSyxDQUFDLFVBQVUsRUFDaEIsS0FBSyxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQ2pDLEVBQUU7S0FDSixDQUFBO0lBRUQsSUFBSSxLQUFLLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRTtRQUM3QixxQkFBcUI7UUFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQzFCLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FDckQsQ0FBQTtLQUNGO1NBQU0sSUFBSSxLQUFLLENBQUMsS0FBSyxLQUFLLGVBQWUsRUFBRTtRQUMxQyx1RUFBdUU7UUFDdkUsT0FBTyxDQUFDLGVBQWUsQ0FBQyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQTtLQUNsRTtJQUVELDhEQUE4RDtJQUM5RCxDQUFDO0lBQUE7UUFDQyxxQkFBcUI7UUFDckIsMEJBQTBCO1FBQzFCLG9CQUFvQjtLQUNyQixDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDM0MsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDN0QsQ0FBQztBQTFGRCwwQ0EwRkM7QUFFRCxTQUFTLFlBQVksQ0FBQyxNQUFNLEdBQUcsRUFBRTtJQUMvQixNQUFNLFdBQVcsR0FBRyxNQUFNO1NBQ3ZCLEtBQUssQ0FBQyxHQUFHLENBQUM7U0FDVixHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUMxQixNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMzRCxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO0lBQzlELE1BQU0sT0FBTyxHQUFHLFdBQVcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQTtJQUN0RCxxREFBcUQ7SUFDckQsT0FBTyxDQUFDLEVBQUUsRUFBRSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQzFELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDbG91ZEZyb250SGVhZGVycyB9IGZyb20gXCJhd3MtbGFtYmRhXCJcbmltcG9ydCB7IHBhcnNlIH0gZnJvbSBcImNvb2tpZVwiXG5pbXBvcnQgeyBkZWNvZGVJZFRva2VuIH0gZnJvbSBcIi4vand0XCJcblxudHlwZSBDb29raWVzID0gUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPlxuXG5leHBvcnQgaW50ZXJmYWNlIENvb2tpZVNldHRpbmdzIHtcbiAgaWRUb2tlbjogc3RyaW5nXG4gIGFjY2Vzc1Rva2VuOiBzdHJpbmdcbiAgcmVmcmVzaFRva2VuOiBzdHJpbmdcbiAgbm9uY2U6IHN0cmluZ1xufVxuXG4vKipcbiAqIENvb2tpZXMgYXJlIHByZXNlbnQgaW4gdGhlIEhUVFAgaGVhZGVyIFwiQ29va2llXCIgdGhhdCBtYXkgYmUgcHJlc2VudFxuICogbXVsdGlwbGUgdGltZXMuIFRoaXMgdXRpbGl0eSBmdW5jdGlvbiBwYXJzZXMgb2NjdXJyZW5jZXMgIG9mIHRoYXRcbiAqIGhlYWRlciBhbmQgc3BsaXRzIG91dCBhbGwgdGhlIGNvb2tpZXMgYW5kIHRoZWlyIHZhbHVlcy5cbiAqIEEgc2ltcGxlIG9iamVjdCBpcyByZXR1cm5lZCB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyBieSBjb29raWVcbiAqIG5hbWU6IGUuZy4gY29va2llc1tcIm5vbmNlXCJdLlxuICovXG5mdW5jdGlvbiBleHRyYWN0Q29va2llc0Zyb21IZWFkZXJzKGhlYWRlcnM6IENsb3VkRnJvbnRIZWFkZXJzKTogQ29va2llcyB7XG4gIGlmICghaGVhZGVyc1tcImNvb2tpZVwiXSkge1xuICAgIHJldHVybiB7fVxuICB9XG4gIGNvbnN0IGNvb2tpZXMgPSBoZWFkZXJzW1wiY29va2llXCJdLnJlZHVjZTxDb29raWVzPihcbiAgICAocmVkdWNlZCwgaGVhZGVyKSA9PiAoe1xuICAgICAgLi4ucmVkdWNlZCxcbiAgICAgIC4uLihwYXJzZShoZWFkZXIudmFsdWUpIGFzIENvb2tpZXMpLFxuICAgIH0pLFxuICAgIHt9LFxuICApXG5cbiAgcmV0dXJuIGNvb2tpZXNcbn1cblxuZnVuY3Rpb24gd2l0aENvb2tpZURvbWFpbihcbiAgZGlzdHJpYnV0aW9uRG9tYWluTmFtZTogc3RyaW5nLFxuICBjb29raWVTZXR0aW5nczogc3RyaW5nLFxuKSB7XG4gIGlmIChjb29raWVTZXR0aW5ncy50b0xvd2VyQ2FzZSgpLmluZGV4T2YoXCJkb21haW5cIikgPT09IC0xKSB7XG4gICAgLy8gQWRkIGxlYWRpbmcgZG90IGZvciBjb21wYXRpYmlsaXR5IHdpdGggQW1wbGlmeSAob3IganMtY29va2llIHJlYWxseSkuXG4gICAgcmV0dXJuIGAke2Nvb2tpZVNldHRpbmdzfTsgRG9tYWluPS4ke2Rpc3RyaWJ1dGlvbkRvbWFpbk5hbWV9YFxuICB9XG4gIHJldHVybiBjb29raWVTZXR0aW5nc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdEFuZFBhcnNlQ29va2llcyhcbiAgaGVhZGVyczogQ2xvdWRGcm9udEhlYWRlcnMsXG4gIGNsaWVudElkOiBzdHJpbmcsXG4pOiB7XG4gIHRva2VuVXNlck5hbWU/OiBzdHJpbmdcbiAgaWRUb2tlbj86IHN0cmluZ1xuICBhY2Nlc3NUb2tlbj86IHN0cmluZ1xuICByZWZyZXNoVG9rZW4/OiBzdHJpbmdcbiAgc2NvcGVzPzogc3RyaW5nXG4gIG5vbmNlPzogc3RyaW5nXG4gIG5vbmNlSG1hYz86IHN0cmluZ1xuICBwa2NlPzogc3RyaW5nXG59IHtcbiAgY29uc3QgY29va2llcyA9IGV4dHJhY3RDb29raWVzRnJvbUhlYWRlcnMoaGVhZGVycylcbiAgaWYgKCFjb29raWVzKSB7XG4gICAgcmV0dXJuIHt9XG4gIH1cblxuICBjb25zdCBrZXlQcmVmaXggPSBgQ29nbml0b0lkZW50aXR5U2VydmljZVByb3ZpZGVyLiR7Y2xpZW50SWR9YFxuICBjb25zdCB0b2tlblVzZXJOYW1lID0gY29va2llc1tgJHtrZXlQcmVmaXh9Lkxhc3RBdXRoVXNlcmBdXG5cbiAgcmV0dXJuIHtcbiAgICB0b2tlblVzZXJOYW1lLFxuICAgIGlkVG9rZW46IGNvb2tpZXNbYCR7a2V5UHJlZml4fS4ke3Rva2VuVXNlck5hbWUgPz8gXCJcIn0uaWRUb2tlbmBdLFxuICAgIGFjY2Vzc1Rva2VuOiBjb29raWVzW2Ake2tleVByZWZpeH0uJHt0b2tlblVzZXJOYW1lID8/IFwiXCJ9LmFjY2Vzc1Rva2VuYF0sXG4gICAgcmVmcmVzaFRva2VuOiBjb29raWVzW2Ake2tleVByZWZpeH0uJHt0b2tlblVzZXJOYW1lID8/IFwiXCJ9LnJlZnJlc2hUb2tlbmBdLFxuICAgIHNjb3BlczogY29va2llc1tgJHtrZXlQcmVmaXh9LiR7dG9rZW5Vc2VyTmFtZSA/PyBcIlwifS50b2tlblNjb3Blc1N0cmluZ2BdLFxuICAgIG5vbmNlOiBjb29raWVzW1wic3BhLWF1dGgtZWRnZS1ub25jZVwiXSxcbiAgICBub25jZUhtYWM6IGNvb2tpZXNbXCJzcGEtYXV0aC1lZGdlLW5vbmNlLWhtYWNcIl0sXG4gICAgcGtjZTogY29va2llc1tcInNwYS1hdXRoLWVkZ2UtcGtjZVwiXSxcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVDb29raWVzKHBhcmFtOiB7XG4gIGV2ZW50OiBcIm5ld1Rva2Vuc1wiIHwgXCJzaWduT3V0XCIgfCBcInJlZnJlc2hGYWlsZWRcIlxuICBjbGllbnRJZDogc3RyaW5nXG4gIG9hdXRoU2NvcGVzOiBzdHJpbmdbXVxuICBkb21haW5OYW1lOiBzdHJpbmdcbiAgY29va2llU2V0dGluZ3M6IENvb2tpZVNldHRpbmdzXG4gIHRva2Vuczoge1xuICAgIGlkVG9rZW46IHN0cmluZ1xuICAgIGFjY2Vzc1Rva2VuOiBzdHJpbmdcbiAgICByZWZyZXNoVG9rZW46IHN0cmluZ1xuICB9XG59KTogc3RyaW5nW10ge1xuICAvLyBTZXQgY29va2llcyB3aXRoIHRoZSBleGFjdCBuYW1lcyBhbmQgdmFsdWVzIEFtcGxpZnkgdXNlc1xuICAvLyBmb3Igc2VhbWxlc3MgaW50ZXJvcGVyYWJpbGl0eSB3aXRoIEFtcGxpZnkuXG4gIGNvbnN0IGRlY29kZWRJZFRva2VuID0gZGVjb2RlSWRUb2tlbihwYXJhbS50b2tlbnMuaWRUb2tlbilcbiAgY29uc3QgdG9rZW5Vc2VyTmFtZSA9IGRlY29kZWRJZFRva2VuW1wiY29nbml0bzp1c2VybmFtZVwiXSBhcyBzdHJpbmdcbiAgY29uc3Qga2V5UHJlZml4ID0gYENvZ25pdG9JZGVudGl0eVNlcnZpY2VQcm92aWRlci4ke3BhcmFtLmNsaWVudElkfWBcbiAgY29uc3QgaWRUb2tlbktleSA9IGAke2tleVByZWZpeH0uJHt0b2tlblVzZXJOYW1lfS5pZFRva2VuYFxuICBjb25zdCBhY2Nlc3NUb2tlbktleSA9IGAke2tleVByZWZpeH0uJHt0b2tlblVzZXJOYW1lfS5hY2Nlc3NUb2tlbmBcbiAgY29uc3QgcmVmcmVzaFRva2VuS2V5ID0gYCR7a2V5UHJlZml4fS4ke3Rva2VuVXNlck5hbWV9LnJlZnJlc2hUb2tlbmBcbiAgY29uc3QgbGFzdFVzZXJLZXkgPSBgJHtrZXlQcmVmaXh9Lkxhc3RBdXRoVXNlcmBcbiAgY29uc3Qgc2NvcGVLZXkgPSBgJHtrZXlQcmVmaXh9LiR7dG9rZW5Vc2VyTmFtZX0udG9rZW5TY29wZXNTdHJpbmdgXG4gIGNvbnN0IHNjb3Blc1N0cmluZyA9IHBhcmFtLm9hdXRoU2NvcGVzLmpvaW4oXCIgXCIpXG4gIGNvbnN0IHVzZXJEYXRhS2V5ID0gYCR7a2V5UHJlZml4fS4ke3Rva2VuVXNlck5hbWV9LnVzZXJEYXRhYFxuICBjb25zdCB1c2VyRGF0YSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICBVc2VyQXR0cmlidXRlczogW1xuICAgICAge1xuICAgICAgICBOYW1lOiBcInN1YlwiLFxuICAgICAgICBWYWx1ZTogZGVjb2RlZElkVG9rZW5bXCJzdWJcIl0sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBOYW1lOiBcImVtYWlsXCIsXG4gICAgICAgIFZhbHVlOiBkZWNvZGVkSWRUb2tlbltcImVtYWlsXCJdLFxuICAgICAgfSxcbiAgICBdLFxuICAgIFVzZXJuYW1lOiB0b2tlblVzZXJOYW1lLFxuICB9KVxuXG4gIC8vIENvbnN0cnVjdCBvYmplY3Qgd2l0aCB0aGUgY29va2llc1xuICBjb25zdCBjb29raWVzID0ge1xuICAgIFtpZFRva2VuS2V5XTogYCR7cGFyYW0udG9rZW5zLmlkVG9rZW59OyAke3dpdGhDb29raWVEb21haW4oXG4gICAgICBwYXJhbS5kb21haW5OYW1lLFxuICAgICAgcGFyYW0uY29va2llU2V0dGluZ3MuaWRUb2tlbixcbiAgICApfWAsXG4gICAgW2FjY2Vzc1Rva2VuS2V5XTogYCR7cGFyYW0udG9rZW5zLmFjY2Vzc1Rva2VufTsgJHt3aXRoQ29va2llRG9tYWluKFxuICAgICAgcGFyYW0uZG9tYWluTmFtZSxcbiAgICAgIHBhcmFtLmNvb2tpZVNldHRpbmdzLmFjY2Vzc1Rva2VuLFxuICAgICl9YCxcbiAgICBbcmVmcmVzaFRva2VuS2V5XTogYCR7cGFyYW0udG9rZW5zLnJlZnJlc2hUb2tlbn07ICR7d2l0aENvb2tpZURvbWFpbihcbiAgICAgIHBhcmFtLmRvbWFpbk5hbWUsXG4gICAgICBwYXJhbS5jb29raWVTZXR0aW5ncy5yZWZyZXNoVG9rZW4sXG4gICAgKX1gLFxuICAgIFtsYXN0VXNlcktleV06IGAke3Rva2VuVXNlck5hbWV9OyAke3dpdGhDb29raWVEb21haW4oXG4gICAgICBwYXJhbS5kb21haW5OYW1lLFxuICAgICAgcGFyYW0uY29va2llU2V0dGluZ3MuaWRUb2tlbixcbiAgICApfWAsXG4gICAgW3Njb3BlS2V5XTogYCR7c2NvcGVzU3RyaW5nfTsgJHt3aXRoQ29va2llRG9tYWluKFxuICAgICAgcGFyYW0uZG9tYWluTmFtZSxcbiAgICAgIHBhcmFtLmNvb2tpZVNldHRpbmdzLmFjY2Vzc1Rva2VuLFxuICAgICl9YCxcbiAgICBbdXNlckRhdGFLZXldOiBgJHtlbmNvZGVVUklDb21wb25lbnQodXNlckRhdGEpfTsgJHt3aXRoQ29va2llRG9tYWluKFxuICAgICAgcGFyYW0uZG9tYWluTmFtZSxcbiAgICAgIHBhcmFtLmNvb2tpZVNldHRpbmdzLmlkVG9rZW4sXG4gICAgKX1gLFxuICAgIFwiYW1wbGlmeS1zaWduaW4td2l0aC1ob3N0ZWRVSVwiOiBgdHJ1ZTsgJHt3aXRoQ29va2llRG9tYWluKFxuICAgICAgcGFyYW0uZG9tYWluTmFtZSxcbiAgICAgIHBhcmFtLmNvb2tpZVNldHRpbmdzLmFjY2Vzc1Rva2VuLFxuICAgICl9YCxcbiAgfVxuXG4gIGlmIChwYXJhbS5ldmVudCA9PT0gXCJzaWduT3V0XCIpIHtcbiAgICAvLyBFeHBpcmUgYWxsIGNvb2tpZXNcbiAgICBPYmplY3Qua2V5cyhjb29raWVzKS5mb3JFYWNoKFxuICAgICAgKGtleSkgPT4gKGNvb2tpZXNba2V5XSA9IGV4cGlyZUNvb2tpZShjb29raWVzW2tleV0pKSxcbiAgICApXG4gIH0gZWxzZSBpZiAocGFyYW0uZXZlbnQgPT09IFwicmVmcmVzaEZhaWxlZFwiKSB7XG4gICAgLy8gRXhwaXJlIHJlZnJlc2ggdG9rZW4gKHNvIHRoZSBicm93c2VyIHdpbGwgbm90IHNlbmQgaXQgaW4gdmFpbiBhZ2FpbilcbiAgICBjb29raWVzW3JlZnJlc2hUb2tlbktleV0gPSBleHBpcmVDb29raWUoY29va2llc1tyZWZyZXNoVG9rZW5LZXldKVxuICB9XG5cbiAgLy8gTm9uY2UsIG5vbmNlSG1hYyBhbmQgcGtjZSBhcmUgb25seSB1c2VkIGR1cmluZyBsb2dpbiBwaGFzZS5cbiAgO1tcbiAgICBcInNwYS1hdXRoLWVkZ2Utbm9uY2VcIixcbiAgICBcInNwYS1hdXRoLWVkZ2Utbm9uY2UtaG1hY1wiLFxuICAgIFwic3BhLWF1dGgtZWRnZS1wa2NlXCIsXG4gIF0uZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29va2llc1trZXldID0gZXhwaXJlQ29va2llKGNvb2tpZXNba2V5XSlcbiAgfSlcblxuICByZXR1cm4gT2JqZWN0LmVudHJpZXMoY29va2llcykubWFwKChbaywgdl0pID0+IGAke2t9PSR7dn1gKVxufVxuXG5mdW5jdGlvbiBleHBpcmVDb29raWUoY29va2llID0gXCJcIikge1xuICBjb25zdCBjb29raWVQYXJ0cyA9IGNvb2tpZVxuICAgIC5zcGxpdChcIjtcIilcbiAgICAubWFwKChwYXJ0KSA9PiBwYXJ0LnRyaW0oKSlcbiAgICAuZmlsdGVyKChwYXJ0KSA9PiAhcGFydC50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoXCJtYXgtYWdlXCIpKVxuICAgIC5maWx0ZXIoKHBhcnQpID0+ICFwYXJ0LnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aChcImV4cGlyZXNcIikpXG4gIGNvbnN0IGV4cGlyZXMgPSBgRXhwaXJlcz0ke25ldyBEYXRlKDApLnRvVVRDU3RyaW5nKCl9YFxuICAvLyBGaXJzdCBwYXJ0IGlzIHRoZSBjb29raWUgdmFsdWUsIHdoaWNoIHdlJ2xsIGNsZWFyLlxuICByZXR1cm4gW1wiXCIsIC4uLmNvb2tpZVBhcnRzLnNsaWNlKDEpLCBleHBpcmVzXS5qb2luKFwiOyBcIilcbn1cbiJdfQ==